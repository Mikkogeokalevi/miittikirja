<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <title>Miittien Tuontity√∂kalu</title>
    <style>
        body { background: #222; color: #fff; font-family: sans-serif; padding: 20px; text-align: center; }
        .container { max-width: 600px; margin: 0 auto; background: #333; padding: 20px; border-radius: 8px; }
        input[type="file"], input[type="text"] { margin: 10px 0; padding: 10px; width: 80%; border-radius: 4px; border: 1px solid #555; background: #222; color: white; }
        .btn { padding: 10px 20px; background: #4caf50; color: white; border: none; cursor: pointer; font-size: 16px; border-radius: 4px; }
        .btn:disabled { background: #555; cursor: not-allowed; }
        #status { margin-top: 20px; white-space: pre-wrap; text-align: left; background: #111; padding: 10px; border: 1px solid #444; min-height: 300px; max-height: 500px; overflow-y: auto; font-family: monospace; }
        .log-ok { color: #4caf50; }
        .log-warn { color: #ffeb3b; }
        .log-err { color: #f44336; }
        .log-skip { color: #777; }
    </style>
</head>
<body>

<div class="container">
    <h2>üì• Tuo omat miitit</h2>
    <p>Lataa "My Finds" GPX geocaching.comista ja sy√∂t√§ nimimerkkisi alle.</p>
    
    <label style="font-weight:bold;">Oma nimimerkkisi (Owner):</label><br>
    <input type="text" id="owner-filter" placeholder="Esim. Mikkokalevi">
    <br>

    <input type="file" id="file-input" accept=".gpx">
    <br>
    
    <div id="auth-section">
        <p>Kirjaudu ensin, jotta tied√§mme kenen kantaan tiedot vied√§√§n.</p>
        <button id="btn-login" class="btn" style="background:#2196f3;">Kirjaudu Googlella</button>
    </div>

    <div id="import-section" style="display:none;">
        <p>Kirjauduttu: <span id="user-email" style="font-weight:bold;"></span></p>
        <button id="btn-process" class="btn" disabled>Suodata ja Tuo miitit</button>
    </div>

    <div id="status">Loki:</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    // =============================================
    // 1. ASETUKSET (Vaihda omat avaimet t√§h√§n!)
    // =============================================
    const firebaseConfig = {
        apiKey: "AIzaSyCZIupycr2puYrPK2KajAW7PcThW9Pjhb0",
        authDomain: "perhekalenteri-projekti.firebaseapp.com",
        databaseURL: "https://perhekalenteri-projekti-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "perhekalenteri-projekti",
        storageBucket: "perhekalenteri-projekti.appspot.com",
        messagingSenderId: "588536838615",
        appId: "1:588536838615:web:148de0581bbd46c42c7392"
    };

    try {
        firebase.initializeApp(firebaseConfig);
    } catch(e) { console.error(e); }

    const db = firebase.database();
    const auth = firebase.auth();
    let currentUser = null;

    const statusEl = document.getElementById('status');
    const fileInput = document.getElementById('file-input');
    const ownerInput = document.getElementById('owner-filter');
    const btnProcess = document.getElementById('btn-process');

    // 2. KIRJAUTUMINEN
    auth.onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('import-section').style.display = 'block';
            document.getElementById('user-email').innerText = user.email;
        }
    });

    document.getElementById('btn-login').addEventListener('click', () => {
        auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    });

    fileInput.addEventListener('change', checkButtonState);
    ownerInput.addEventListener('input', checkButtonState);

    function checkButtonState() {
        if(fileInput.files.length > 0 && ownerInput.value.trim().length > 0) {
            btnProcess.disabled = false;
        } else {
            btnProcess.disabled = true;
        }
    }

    // 3. TIEDOSTON K√ÑSITTELY
    btnProcess.addEventListener('click', () => {
        const file = fileInput.files[0];
        const myName = ownerInput.value.trim().toLowerCase();
        
        if (!file || !myName) return;

        statusEl.innerHTML = "Aloitetaan tiedoston luku...\n";
        const reader = new FileReader();

        reader.onload = function(e) {
            const xmlText = e.target.result;
            parseGPX(xmlText, myName);
        };
        
        reader.readAsText(file);
    });

    function parseGPX(xmlText, myName) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "text/xml");
        const wpts = xmlDoc.getElementsByTagName("wpt");
        
        log(`L√∂ydetty ${wpts.length} reittipistett√§ tiedostosta.`, "normal");
        log(`Suodatetaan miitit, joiden j√§rjest√§j√§ on: "${myName}"`, "normal");
        log("---------------------------------------------------", "normal");
        
        let eventCount = 0;
        let promises = [];

        for (let i = 0; i < wpts.length; i++) {
            const wpt = wpts[i];
            
            // Haetaan tagit
            const gcCode = getTagVal(wpt, "name");
            const type = getTagVal(wpt, "type") || ""; // "Geocache|Event Cache"
            
            // Groundspeak laajennukset (omistaja l√∂ytyy t√§√§lt√§)
            let owner = "";
            let eventName = "";
            
            // Yritet√§√§n l√∂yt√§√§ groundspeak:cache -tagi
            const gsCache = wpt.getElementsByTagName("groundspeak:cache")[0];
            if (gsCache) {
                owner = getTagVal(gsCache, "groundspeak:placed_by");
                eventName = getTagVal(gsCache, "groundspeak:name");
            } else {
                // Fallback jos ei groundspeak laajennusta
                owner = getTagVal(wpt, "groundspeak:placed_by") || getTagVal(wpt, "placed_by");
                eventName = getTagVal(wpt, "urlname") || getTagVal(wpt, "desc");
            }

            // TARKISTUKSET:
            // 1. Onko tyyppi Event, CITO, Mega, Giga?
            const isEvent = type.toLowerCase().includes("event") || 
                          type.toLowerCase().includes("cito") || 
                          type.toLowerCase().includes("mega") || 
                          type.toLowerCase().includes("lost and found"); // 10v miitit

            // 2. T√§sm√§√§k√∂ omistaja?
            const isMine = owner && owner.toLowerCase() === myName;

            if (isEvent) {
                if (isMine) {
                    // T√ÑM√Ñ ON SINUN MIITTI -> TALLENNETAAN
                    const time = getTagVal(wpt, "time");
                    let dateStr = time ? time.split("T")[0] : "1970-01-01";
                    
                    const lat = wpt.getAttribute("lat");
                    const lon = wpt.getAttribute("lon");

                    const eventData = {
                        gc: gcCode,
                        name: eventName,
                        date: dateStr,
                        location: `${lat}, ${lon}`,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    };

                    log(`‚úÖ TUODAAN: ${eventName} (${gcCode}) - ${dateStr}`, "log-ok");
                    
                    const p = db.ref('miitit/' + currentUser.uid + '/events').push(eventData);
                    promises.push(p);
                    eventCount++;
                } else {
                    // Toisen j√§rjest√§m√§ miitti
                    log(`‚è≠Ô∏è Ohitetaan (Toisen miitti): ${eventName} (tekij√§: ${owner})`, "log-skip");
                }
            }
        }

        log("---------------------------------------------------", "normal");
        if (eventCount === 0) {
            log("‚ö†Ô∏è Yht√§√§n sinun j√§rjest√§m√§√§si miitti√§ ei l√∂ytynyt.", "log-warn");
            log("Vinkki: Tarkista kirjoititko nimimerkkisi t√§sm√§lleen oikein.", "log-warn");
        } else {
            Promise.all(promises).then(() => {
                log(`\nüéâ VALMIS! ${eventCount} omaa miitti√§si tallennettu kantaan.`, "log-ok");
            }).catch(err => {
                log("Virhe tallennuksessa: " + err.message, "log-err");
            });
        }
    }

    // Hakee XML-tagin arvon, tukee namespaceja "groundspeak:name"
    function getTagVal(parent, tagName) {
        let el = parent.getElementsByTagName(tagName)[0];
        if (!el && tagName.includes(":")) {
             // Jos selain ei tue namespace-hakua suoraan, kokeillaan ilman etuliitett√§
             const cleanName = tagName.split(":")[1];
             el = parent.getElementsByTagName(cleanName)[0];
        }
        return el ? el.textContent : "";
    }

    function log(msg, type) {
        const span = document.createElement('div');
        span.innerText = msg;
        if(type === 'log-ok') span.className = 'log-ok';
        if(type === 'log-warn') span.className = 'log-warn';
        if(type === 'log-err') span.className = 'log-err';
        if(type === 'log-skip') span.className = 'log-skip';
        statusEl.appendChild(span);
        // Autoscroll
        statusEl.scrollTop = statusEl.scrollHeight; 
    }
</script>

</body>
</html>
