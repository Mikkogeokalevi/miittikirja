<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <title>Miittien Valikoiva Tuonti</title>
    <style>
        body { background: #222; color: #fff; font-family: sans-serif; padding: 20px; text-align: center; }
        .container { max-width: 900px; margin: 0 auto; background: #333; padding: 20px; border-radius: 8px; }
        
        input[type="text"], input[type="file"] { 
            margin: 10px 0; padding: 10px; width: 80%; 
            border-radius: 4px; border: 1px solid #555; 
            background: #222; color: white; 
        }
        
        .btn { padding: 12px 25px; border: none; cursor: pointer; font-size: 16px; border-radius: 4px; font-weight: bold; margin: 5px; }
        .btn:disabled { background: #555; cursor: not-allowed; opacity: 0.5; }
        .btn-blue { background: #2196f3; color: white; }
        .btn-green { background: #4caf50; color: white; }
        .btn-gray { background: #666; color: white; font-size: 14px; padding: 8px 15px; }

        /* LISTA TYYLIT */
        #preview-area { display: none; text-align: left; margin-top: 20px; border-top: 1px solid #555; padding-top: 20px; }
        
        .event-list { 
            max-height: 500px; overflow-y: auto; 
            background: #222; border: 1px solid #444; 
            border-radius: 4px; padding: 10px; margin-bottom: 20px; 
        }
        
        .event-row { 
            display: flex; align-items: center; 
            padding: 8px; border-bottom: 1px solid #333; 
        }
        .event-row:hover { background: #2a2a2a; }
        
        .chk-col { width: 40px; text-align: center; }
        .info-col { flex: 1; padding-left: 10px; }
        .status-col { width: 120px; text-align: right; font-size: 0.8em; color: #888; }
        
        .duplicate { opacity: 0.5; }
        .highlight { color: #4caf50; }
        input[type="checkbox"] { transform: scale(1.5); cursor: pointer; }

        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .user-badge { background: #2196f3; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="container">
    <h2>üì• Tuo miitit (Valitse listasta)</h2>
    
    <div id="step-1">
        <p>1. Kirjoita nimimerkki (esim. <em>NastoGeo</em> tai <em>MiLahTi</em>) ja valitse GPX-tiedosto.</p>
        <label>Etsitt√§v√§ omistaja (Owner):</label><br>
        <input type="text" id="owner-filter" placeholder="Esim. NastoGeo">
        <br>
        <input type="file" id="file-input" accept=".gpx">
        
        <div id="auth-section" style="margin-top:20px;">
            <p>Kirjaudu ensin:</p>
            <button id="btn-login" class="btn btn-blue">Kirjaudu Googlella</button>
        </div>

        <div id="analyze-section" style="display:none; margin-top:20px;">
            <p>Kirjautunut: <span id="user-email" class="user-badge"></span></p>
            <button id="btn-analyze" class="btn btn-blue" disabled>üîç 1. Etsi tiedostosta</button>
        </div>
    </div>

    <div id="preview-area">
        <div class="controls">
            <h3>L√∂ydetyt tapahtumat (<span id="found-count">0</span>)</h3>
            <div>
                <button class="btn btn-gray" onclick="toggleAll(true)">Valitse kaikki</button>
                <button class="btn btn-gray" onclick="toggleAll(false)">Poista valinnat</button>
            </div>
        </div>

        <div id="event-list-container" class="event-list">
            </div>

        <div style="text-align: right;">
            <span id="selection-count" style="margin-right: 10px; color:#aaa;">0 valittu</span>
            <button id="btn-import" class="btn btn-green">üíæ 2. Tuo valitut kantaan</button>
        </div>
    </div>
    
    <div id="log-output" style="margin-top:20px; color:#888; font-family:monospace; text-align:left;"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    // =============================================
    // ASETUKSET
    // =============================================
    const firebaseConfig = {
        apiKey: "AIzaSyCZIupycr2puYrPK2KajAW7PcThW9Pjhb0",
        authDomain: "perhekalenteri-projekti.firebaseapp.com",
        databaseURL: "https://perhekalenteri-projekti-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "perhekalenteri-projekti",
        storageBucket: "perhekalenteri-projekti.appspot.com",
        messagingSenderId: "588536838615",
        appId: "1:588536838615:web:148de0581bbd46c42c7392"
    };

    try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
    const db = firebase.database();
    const auth = firebase.auth();
    let currentUser = null;
    let foundEventsCache = []; // T√§h√§n tallennetaan l√∂ydetyt v√§liaikaisesti

    // UI Elementit
    const fileInput = document.getElementById('file-input');
    const ownerInput = document.getElementById('owner-filter');
    const btnAnalyze = document.getElementById('btn-analyze');
    const btnImport = document.getElementById('btn-import');
    const listContainer = document.getElementById('event-list-container');
    const previewArea = document.getElementById('preview-area');
    const logOut = document.getElementById('log-output');

    // 1. KIRJAUTUMINEN
    auth.onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('analyze-section').style.display = 'block';
            document.getElementById('user-email').innerText = user.email;
        }
    });

    document.getElementById('btn-login').addEventListener('click', () => { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); });

    fileInput.addEventListener('change', checkBtn);
    ownerInput.addEventListener('input', checkBtn);
    function checkBtn() { btnAnalyze.disabled = !(fileInput.files.length > 0 && ownerInput.value.trim().length > 0); }

    // 2. ANALYSOINTI (EI VIEL√Ñ TALLENNUSTA)
    btnAnalyze.addEventListener('click', () => {
        const file = fileInput.files[0];
        const myName = ownerInput.value.trim().toLowerCase();
        
        logOut.innerText = "Analysoidaan tiedostoa...";
        previewArea.style.display = 'none';
        foundEventsCache = []; // Tyhjenn√§ vanhat

        // Haetaan ensin tietokannasta jo olemassa olevat GC-koodit
        db.ref('miitit/' + currentUser.uid + '/events').once('value').then((snapshot) => {
            const existingGCs = new Set();
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const val = child.val();
                    if (val.gc) existingGCs.add(val.gc);
                });
            }
            
            const reader = new FileReader();
            reader.onload = (e) => parseGPX(e.target.result, myName, existingGCs);
            reader.readAsText(file);
        });
    });

    function parseGPX(xmlText, myName, existingGCs) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "text/xml");
        const wpts = xmlDoc.getElementsByTagName("wpt");
        
        let count = 0;

        for (let i = 0; i < wpts.length; i++) {
            const wpt = wpts[i];
            
            // Tarkista omistaja (tai nimimerkin osa)
            let owner = getTagVal(wpt, "groundspeak:placed_by") || getTagVal(wpt, "placed_by");
            if (!owner || !owner.toLowerCase().includes(myName)) continue;

            const gc = getTagVal(wpt, "name");
            const typeStr = getTagVal(wpt, "type").toLowerCase();
            
            // Onko miitti?
            let myType = "miitti"; 
            let isEvent = false;
            if (typeStr.includes("event cache")) { isEvent = true; }
            else if (typeStr.includes("cache in trash out")) { isEvent = true; myType = "cito"; }
            else if (typeStr.includes("community celebration") || typeStr.includes("lost and found") || typeStr.includes("celebration") || typeStr.includes("yhteis√∂")) { 
                isEvent = true; myType = "cce"; 
            }
            else if (typeStr.includes("mega")) { isEvent = true; } 

            if (isEvent) {
                // Haetaan tiedot talteen muistiin (EI VIEL√Ñ KANTAAN)
                const gsCache = wpt.getElementsByTagName("groundspeak:cache")[0];
                let name = getTagVal(wpt, "urlname") || getTagVal(wpt, "desc");
                if(gsCache) name = getTagVal(gsCache, "groundspeak:name");

                const time = getTagVal(wpt, "time");
                const dateStr = time ? time.split("T")[0] : "";
                const lat = wpt.getAttribute("lat");
                const lon = wpt.getAttribute("lon");

                // Attribuutit
                const attributes = [];
                const attrList = wpt.getElementsByTagName("groundspeak:attribute");
                for(let k=0; k < attrList.length; k++) {
                    if(attrList[k].getAttribute("inc") == "1") attributes.push(attrList[k].textContent);
                }

                // Onko jo kannassa?
                const isDuplicate = existingGCs.has(gc);

                foundEventsCache.push({
                    id: i, // Uniikki ID listalle
                    data: {
                        type: myType,
                        gc: gc,
                        name: name,
                        date: dateStr,
                        coords: `${lat}, ${lon}`,
                        location: "", 
                        attributes: attributes,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    },
                    isDuplicate: isDuplicate
                });
                count++;
            }
        }

        renderList();
    }

    // 3. RENDER√ñI LISTA
    function renderList() {
        listContainer.innerHTML = "";
        const countEl = document.getElementById('found-count');
        countEl.innerText = foundEventsCache.length;

        if (foundEventsCache.length === 0) {
            logOut.innerText = "Yht√§√§n tapahtumaa ei l√∂ytynyt hakusanalla.";
            return;
        }

        foundEventsCache.forEach((item, idx) => {
            const row = document.createElement('div');
            row.className = "event-row " + (item.isDuplicate ? "duplicate" : "");
            
            // Checkbox (Disabloitu jos duplikaatti, muuten valittu)
            const isChecked = !item.isDuplicate;
            const isDisabled = item.isDuplicate ? "disabled" : "";
            const statusText = item.isDuplicate ? "Jo kannassa" : "Uusi";
            
            row.innerHTML = `
                <div class="chk-col">
                    <input type="checkbox" class="event-chk" data-idx="${idx}" ${isChecked ? "checked" : ""} ${isDisabled}>
                </div>
                <div class="info-col">
                    <div style="font-weight:bold; color: ${item.isDuplicate ? '#777' : '#fff'}">${item.data.name}</div>
                    <div style="font-size:0.9em; color:#aaa;">${item.data.gc} ‚Ä¢ ${item.data.date} ‚Ä¢ ${item.data.type.toUpperCase()}</div>
                </div>
                <div class="status-col">
                    ${statusText}
                </div>
            `;
            listContainer.appendChild(row);
        });

        previewArea.style.display = 'block';
        logOut.innerText = `L√∂ydettiin ${foundEventsCache.length} tapahtumaa. Valitse tuotavat.`;
        updateSelectionCount();
        
        // Kuuntele muutoksia
        document.querySelectorAll('.event-chk').forEach(chk => {
            chk.addEventListener('change', updateSelectionCount);
        });
    }

    // 4. TUO VALITUT KANTAAN
    btnImport.addEventListener('click', () => {
        const checkboxes = document.querySelectorAll('.event-chk:checked');
        if (checkboxes.length === 0) { alert("Valitse v√§hint√§√§n yksi!"); return; }

        if (!confirm(`Haluatko varmasti tuoda ${checkboxes.length} tapahtumaa kantaan?`)) return;

        let successCount = 0;
        checkboxes.forEach(chk => {
            const idx = chk.getAttribute('data-idx');
            const eventData = foundEventsCache[idx].data;
            
            // TALLENNUS FIREBASEEN
            db.ref('miitit/' + currentUser.uid + '/events').push(eventData);
            successCount++;
        });

        alert(`‚úÖ Valmis! ${successCount} tapahtumaa lis√§tty onnistuneesti.`);
        previewArea.style.display = 'none';
        ownerInput.value = ""; // Tyhjennys
        logOut.innerText = "Tuonti valmis.";
    });

    // APUFUNKTIOT
    window.toggleAll = (state) => {
        document.querySelectorAll('.event-chk:not(:disabled)').forEach(chk => chk.checked = state);
        updateSelectionCount();
    };

    function updateSelectionCount() {
        const count = document.querySelectorAll('.event-chk:checked').length;
        document.getElementById('selection-count').innerText = `${count} valittu`;
    }

    function getTagVal(parent, tagName) {
        let el = parent.getElementsByTagName(tagName)[0];
        if (!el && tagName.includes(":")) el = parent.getElementsByTagName(tagName.split(":")[1])[0];
        return el ? el.textContent : "";
    }
</script>
</body>
</html>
