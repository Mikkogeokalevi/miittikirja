<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <title>Miittien Tuonti (Varmistus)</title>
    <style>
        body { background: #222; color: #fff; font-family: sans-serif; padding: 20px; text-align: center; }
        .container { max-width: 800px; margin: 0 auto; background: #333; padding: 20px; border-radius: 8px; }
        input { margin: 10px 0; padding: 10px; width: 80%; border-radius: 4px; border: 1px solid #555; background: #222; color: white; }
        .btn { padding: 10px 20px; background: #4caf50; color: white; border: none; cursor: pointer; font-size: 16px; border-radius: 4px; }
        .btn:disabled { background: #555; cursor: not-allowed; }
        
        #status { 
            margin-top: 20px; 
            text-align: left; 
            background: #111; 
            padding: 15px; 
            border: 1px solid #444; 
            height: 400px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 14px;
            white-space: pre-wrap;
        }
        .user-badge {
            background: #2196f3;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }
        .log-row { border-bottom: 1px solid #222; padding: 2px 0; }
        .log-ok { color: #4caf50; font-weight: bold; }
        .log-warn { color: #ffeb3b; }
        .log-err { color: #f44336; }
        .log-info { color: #888; }
        .log-skip { color: #aaa; font-style: italic; }
    </style>
</head>
<body>

<div class="container">
    <h2>üì• Tuo omat tapahtumat</h2>
    
    <label>Oma nimimerkki (Owner):</label><br>
    <input type="text" id="owner-filter" placeholder="Esim. Mikkokalevi">
    <br>
    <input type="file" id="file-input" accept=".gpx">
    
    <div id="auth-section">
        <p>Kirjaudu ensin:</p>
        <button id="btn-login" class="btn" style="background:#2196f3;">Kirjaudu Googlella</button>
    </div>

    <div id="import-section" style="display:none;">
        <p>Olet kirjautunut sis√§√§n tunnuksella:<br><br>
           <span id="user-email" class="user-badge"></span>
        </p>
        <p style="font-size:0.9em; color:#aaa;">(Varmista, ett√§ t√§m√§ on sama kuin Miittikirjassa!)</p>
        <button id="btn-process" class="btn" disabled>Analysoi ja Tuo</button>
    </div>

    <div id="status">Loki:</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    // =============================================
    // ASETUKSET
    // =============================================
    const firebaseConfig = {
        apiKey: "AIzaSyCZIupycr2puYrPK2KajAW7PcThW9Pjhb0",
        authDomain: "perhekalenteri-projekti.firebaseapp.com",
        databaseURL: "https://perhekalenteri-projekti-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "perhekalenteri-projekti",
        storageBucket: "perhekalenteri-projekti.appspot.com",
        messagingSenderId: "588536838615",
        appId: "1:588536838615:web:148de0581bbd46c42c7392"
    };

    try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
    const db = firebase.database();
    const auth = firebase.auth();
    let currentUser = null;

    const statusEl = document.getElementById('status');
    const fileInput = document.getElementById('file-input');
    const ownerInput = document.getElementById('owner-filter');
    const btnProcess = document.getElementById('btn-process');

    auth.onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('import-section').style.display = 'block';
            document.getElementById('user-email').innerText = user.email;
        }
    });

    document.getElementById('btn-login').addEventListener('click', () => { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); });

    fileInput.addEventListener('change', checkBtn);
    ownerInput.addEventListener('input', checkBtn);
    function checkBtn() { btnProcess.disabled = !(fileInput.files.length > 0 && ownerInput.value.trim().length > 0); }

    btnProcess.addEventListener('click', () => {
        const file = fileInput.files[0];
        const myName = ownerInput.value.trim().toLowerCase();
        
        statusEl.innerHTML = ""; 
        log(`Haetaan ensin olemassa olevat miitit kannasta...`, "log-info");

        db.ref('miitit/' + currentUser.uid + '/events').once('value').then((snapshot) => {
            const existingGCs = new Set();
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const val = child.val();
                    if (val.gc) existingGCs.add(val.gc);
                });
            }
            log(`Kannasta l√∂ytyi ${existingGCs.size} aiempaa miitti√§.`, "log-info");
            
            const reader = new FileReader();
            reader.onload = (e) => parseGPX(e.target.result, myName, existingGCs);
            reader.readAsText(file);
        });
    });

    function parseGPX(xmlText, myName, existingGCs) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "text/xml");
        const wpts = xmlDoc.getElementsByTagName("wpt");
        
        log(`Tiedostossa on ${wpts.length} pistett√§. Aloitetaan l√§pik√§ynti...`, "log-info");
        log("---------------------------------------------------", "log-info");

        let importedCount = 0;
        let skippedCount = 0;
        let duplicateCount = 0;

        for (let i = 0; i < wpts.length; i++) {
            const wpt = wpts[i];
            
            let owner = getTagVal(wpt, "groundspeak:placed_by") || getTagVal(wpt, "placed_by");
            if (owner && owner.toLowerCase() === myName) {
                
                const gc = getTagVal(wpt, "name");
                
                if (existingGCs.has(gc)) {
                    log(`‚è≠Ô∏è OHITETTU (Jo kannassa): ${gc}`, "log-skip");
                    duplicateCount++;
                    continue; 
                }

                const gsCache = wpt.getElementsByTagName("groundspeak:cache")[0];
                let name = getTagVal(wpt, "urlname") || getTagVal(wpt, "desc");
                if(gsCache) name = getTagVal(gsCache, "groundspeak:name");

                let typeStr = getTagVal(wpt, "type").toLowerCase();
                let myType = "miitti"; 
                let isEvent = false;

                if (typeStr.includes("event cache")) { isEvent = true; }
                else if (typeStr.includes("cache in trash out")) { isEvent = true; myType = "cito"; }
                else if (typeStr.includes("community celebration") || typeStr.includes("lost and found") || typeStr.includes("celebration") || typeStr.includes("yhteis√∂")) { 
                    isEvent = true; myType = "cce"; 
                }
                else if (typeStr.includes("mega")) { isEvent = true; } 

                if (isEvent) {
                    const time = getTagVal(wpt, "time");
                    const dateStr = time ? time.split("T")[0] : "";
                    const lat = wpt.getAttribute("lat");
                    const lon = wpt.getAttribute("lon");

                    // Attribuutit
                    const attributes = [];
                    const attrList = wpt.getElementsByTagName("groundspeak:attribute");
                    for(let k=0; k < attrList.length; k++) {
                        if(attrList[k].getAttribute("inc") == "1") attributes.push(attrList[k].textContent);
                    }

                    const eventData = {
                        type: myType,
                        gc: gc,
                        name: name,
                        date: dateStr,
                        coords: `${lat}, ${lon}`,
                        location: "", 
                        attributes: attributes,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    };

                    log(`‚úÖ TUOTU: ${name} (${gc})`, "log-ok");
                    db.ref('miitit/' + currentUser.uid + '/events').push(eventData);
                    importedCount++;
                } else {
                    skippedCount++;
                }
            }
        }

        log("---------------------------------------------------", "log-info");
        log(`VALMIS!`, "log-info");
        log(`- Uusia tuotu: ${importedCount}`, "log-ok");
        log(`- Vanhoja (ohitettu): ${duplicateCount}`, "log-skip");
        
        if (importedCount === 0 && duplicateCount === 0) {
            log(`\n‚ö†Ô∏è Yht√§√§n miitti√§ ei l√∂ytynyt. Tarkista nimimerkki!`, "log-err");
        }
    }

    function getTagVal(parent, tagName) {
        let el = parent.getElementsByTagName(tagName)[0];
        if (!el && tagName.includes(":")) el = parent.getElementsByTagName(tagName.split(":")[1])[0];
        return el ? el.textContent : "";
    }

    function log(msg, cls) {
        const div = document.createElement('div'); 
        div.innerText = msg; 
        div.className = "log-row " + cls; 
        statusEl.appendChild(div);
        statusEl.scrollTop = statusEl.scrollHeight;
    }
</script>
</body>
</html>
