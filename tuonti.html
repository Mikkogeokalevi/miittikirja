<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <title>Miittien Tuonti</title>
    <style>
        body { background: #222; color: #fff; font-family: sans-serif; padding: 20px; text-align: center; }
        .container { max-width: 600px; margin: 0 auto; background: #333; padding: 20px; border-radius: 8px; }
        input { margin: 10px 0; padding: 10px; width: 80%; border-radius: 4px; border: 1px solid #555; background: #222; color: white; }
        .btn { padding: 10px 20px; background: #4caf50; color: white; border: none; cursor: pointer; font-size: 16px; border-radius: 4px; }
        .btn:disabled { background: #555; cursor: not-allowed; }
        #status { margin-top: 20px; white-space: pre-wrap; text-align: left; background: #111; padding: 10px; border: 1px solid #444; min-height: 300px; max-height: 500px; overflow-y: auto; font-family: monospace; }
        .log-ok { color: #4caf50; } .log-skip { color: #777; }
    </style>
</head>
<body>

<div class="container">
    <h2>üì• Tuo kaikki omat tapahtumat</h2>
    <p>Lataa GPX (mieluiten "My Hides" tai "My Finds") ja sy√∂t√§ nimimerkkisi.</p>
    
    <label>Oma nimimerkki (Owner):</label><br>
    <input type="text" id="owner-filter" placeholder="Esim. Mikkokalevi">
    <br>
    <input type="file" id="file-input" accept=".gpx">
    
    <div id="auth-section">
        <button id="btn-login" class="btn" style="background:#2196f3;">Kirjaudu Googlella</button>
    </div>

    <div id="import-section" style="display:none;">
        <p>Kirjautunut: <span id="user-email"></span></p>
        <button id="btn-process" class="btn" disabled>Suodata ja Tuo</button>
    </div>

    <div id="status">Loki:</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCZIupycr2puYrPK2KajAW7PcThW9Pjhb0",
        authDomain: "perhekalenteri-projekti.firebaseapp.com",
        databaseURL: "https://perhekalenteri-projekti-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "perhekalenteri-projekti",
        storageBucket: "perhekalenteri-projekti.appspot.com",
        messagingSenderId: "588536838615",
        appId: "1:588536838615:web:148de0581bbd46c42c7392"
    };

    try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
    const db = firebase.database();
    const auth = firebase.auth();
    let currentUser = null;

    const statusEl = document.getElementById('status');
    const fileInput = document.getElementById('file-input');
    const ownerInput = document.getElementById('owner-filter');
    const btnProcess = document.getElementById('btn-process');

    auth.onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('import-section').style.display = 'block';
            document.getElementById('user-email').innerText = user.email;
        }
    });

    document.getElementById('btn-login').addEventListener('click', () => { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); });

    fileInput.addEventListener('change', checkBtn);
    ownerInput.addEventListener('input', checkBtn);
    function checkBtn() { btnProcess.disabled = !(fileInput.files.length > 0 && ownerInput.value.trim().length > 0); }

    btnProcess.addEventListener('click', () => {
        const file = fileInput.files[0];
        const myName = ownerInput.value.trim().toLowerCase();
        const reader = new FileReader();
        reader.onload = (e) => parseGPX(e.target.result, myName);
        reader.readAsText(file);
    });

    function parseGPX(xmlText, myName) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "text/xml");
        const wpts = xmlDoc.getElementsByTagName("wpt");
        
        statusEl.innerHTML = `Tutkitaan ${wpts.length} pistett√§...\n`;
        let count = 0;

        for (let i = 0; i < wpts.length; i++) {
            const wpt = wpts[i];
            
            // 1. Tunnistetaan omistaja (Placed By)
            // T√§m√§ nappaa my√∂s perutut, jos ne ovat GPX:ss√§, koska omistaja on sama.
            let owner = getTagVal(wpt, "groundspeak:placed_by") || getTagVal(wpt, "placed_by");
            if (!owner || owner.toLowerCase() !== myName) continue;

            // 2. Tunnistetaan tyyppi
            let typeStr = getTagVal(wpt, "type").toLowerCase();
            let myType = "miitti"; 
            let isEvent = false;

            // T√§ss√§ lis√§tty tuki "Celebration" ja "Yhteis√∂juhla" sanoille
            if (typeStr.includes("event cache")) { isEvent = true; }
            else if (typeStr.includes("cache in trash out")) { isEvent = true; myType = "cito"; }
            else if (typeStr.includes("community celebration") || typeStr.includes("lost and found") || typeStr.includes("celebration") || typeStr.includes("yhteis√∂")) { 
                isEvent = true; 
                myType = "cce"; 
            }
            else if (typeStr.includes("mega")) { isEvent = true; } 

            if (isEvent) {
                const gc = getTagVal(wpt, "name");
                let name = getTagVal(wpt, "urlname") || getTagVal(wpt, "desc");
                const gsCache = wpt.getElementsByTagName("groundspeak:cache")[0];
                if(gsCache) name = getTagVal(gsCache, "groundspeak:name");

                const time = getTagVal(wpt, "time");
                const dateStr = time ? time.split("T")[0] : "";
                
                // Koordinaatit talteen!
                const lat = wpt.getAttribute("lat");
                const lon = wpt.getAttribute("lon");

                const eventData = {
                    type: myType,
                    gc: gc,
                    name: name,
                    date: dateStr,
                    coords: `${lat}, ${lon}`,
                    location: "", 
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                };

                log(`‚úÖ [${myType.toUpperCase()}] ${name} (${dateStr})`, "log-ok");
                db.ref('miitit/' + currentUser.uid + '/events').push(eventData);
                count++;
            }
        }
        log(`\nVALMIS! ${count} omaa tapahtumaa tuotu.`, "log-ok");
    }

    function getTagVal(parent, tagName) {
        let el = parent.getElementsByTagName(tagName)[0];
        if (!el && tagName.includes(":")) el = parent.getElementsByTagName(tagName.split(":")[1])[0];
        return el ? el.textContent : "";
    }

    function log(msg, cls) {
        const div = document.createElement('div'); div.innerText = msg; div.className = cls; statusEl.appendChild(div);
        statusEl.scrollTop = statusEl.scrollHeight;
    }
</script>
</body>
</html>
