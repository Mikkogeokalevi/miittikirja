<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MK:n SÃ¤hkÃ¶inen Miittikirja</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    
    <meta name="theme-color" content="#8B4513">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png"> 

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>

    <div id="loading-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; justify-content:center; align-items:center; font-size:1.5em; font-weight:bold; color:#8B4513;">â³ KÃ¤sitellÃ¤Ã¤n tietoja...</div>

    <img src="https://img.geocaching.com:443/d75362fa-0668-414e-adb7-20a2b35c3eed.png" class="logo-img" alt="Mikkokalevin logo">
    
    <div id="user-display" class="user-info-bar">
        <div class="user-info-row">
            <span id="user-email-text"></span>
            <div style="display:flex; gap:5px;">
                <button id="btn-theme-toggle" class="btn btn-small btn-gray" style="margin:0; width:40px;" onclick="toggleTheme()">ğŸŒ™</button>
                <button id="btn-toggle-mode" class="btn btn-small btn-gray" style="margin:0;">ğŸ”„ Vaihda nÃ¤kymÃ¤Ã¤</button>
            </div>
        </div>
        <div id="version-display-user"></div>
    </div>

    <div id="login-view" class="view-section" style="display:flex; flex-direction:column; align-items:center;">
        <h2>SÃ¤hkÃ¶inen Miittikirja</h2>
        <p style="color:#888; margin-bottom:20px;">Vain yllÃ¤pitÃ¤jÃ¤n kirjautuminen.</p>
        
        <input type="email" id="email-input" placeholder="SÃ¤hkÃ¶posti" style="margin-bottom:15px;">
        <input type="password" id="password-input" placeholder="Salasana" style="margin-bottom:20px;">
        
        <button id="btn-email-login" class="btn btn-green" style="font-size:1.2em;">KIRJAUDU SISÃ„Ã„N</button>
        
        <div id="version-display-login"></div>
    </div>

    <div id="visitor-view" class="view-section">
        
        <div style="display:flex; justify-content:center; gap:20px; margin-bottom:15px;">
            <button id="btn-lang-fi" onclick="setVisitorLanguage('fi')" style="border:none; background:none; font-size:2.5em; cursor:pointer; opacity:1; transition:opacity 0.2s;">ğŸ‡«ğŸ‡®</button>
            <button id="btn-lang-en" onclick="setVisitorLanguage('en')" style="border:none; background:none; font-size:2.5em; cursor:pointer; opacity:0.5; transition:opacity 0.2s;">ğŸ‡¬ğŸ‡§</button>
            <button id="btn-lang-sv" onclick="setVisitorLanguage('sv')" style="border:none; background:none; font-size:2.5em; cursor:pointer; opacity:0.5; transition:opacity 0.2s;">ğŸ‡¸ğŸ‡ª</button>
            <button id="btn-lang-et" onclick="setVisitorLanguage('et')" style="border:none; background:none; font-size:2.5em; cursor:pointer; opacity:0.5; transition:opacity 0.2s;">ğŸ‡ªğŸ‡ª</button>
        </div>

        <h2 id="vv-ui-title" style="text-align:center; font-size:1.4em; margin-bottom:5px; color:#555;">Mikkokalevin SÃ¤hkÃ¶inen Vieraskirja</h2>
        <h3 id="vv-event-name" style="text-align:center; color:var(--primary-color); margin-top:0; font-size:1.6em;">Miitti</h3>
        
        <div class="card"><p id="vv-event-info" style="text-align:center; font-weight:bold;"></p></div>
        <div id="vv-expiry-info" class="card" style="text-align:center; font-size:0.9em;"></div>
        <div id="vv-expired" class="card" style="display:none; text-align:center; border:2px solid #B22222; color:#B22222;"></div>
        
        <div class="card-form">
            <h3 id="vv-ui-subtitle" style="text-align:center; color:#B22222;">âœï¸ Kirjaa kÃ¤yntisi vieraskirjaan</h3>
            
            <div style="position:relative;">
                <input type="text" id="vv-nickname" placeholder="Nimimerkkisi (kuten Geocaching.com)" style="font-size: 1.2em; border: 2px solid #8B4513;">
                <div id="vv-autocomplete" class="autocomplete-list" style="display:none;"></div>
            </div>
            
            <small style="display:block; color:#666; margin-top:2px; margin-bottom:10px; font-style:italic;">(Kirjoita kuten Geocaching.comissa)</small>
            
            <input type="text" id="vv-from" placeholder="MistÃ¤ tulet? (Paikkakunta)">
            <input type="text" id="vv-message" placeholder="Terveiset Mikkokaleville">
            
            <button id="btn-visitor-sign" class="btn btn-green" onclick="handleVisitorSign()" style="font-size: 1.2em; box-shadow: 4px 4px 0px #2e7d32;">TALLENNA KÃ„YNTI âœ…</button>
            
            <p id="vv-ui-reminder" style="color:#d32f2f; font-weight:bold; text-align:center; margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;">âš ï¸ Muista logata kÃ¤yntisi myÃ¶s virallisesti Geocaching.comiin!</p>
        </div>
    </div>

    <div id="admin-view" class="view-section">
        <div id="today-notice-admin"></div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h3 style="margin:0;">ğŸ› ï¸ Hallinta</h3>
            <button id="btn-logout" class="btn btn-red btn-small">Ulos</button>
        </div>
        <div style="display:flex; gap:10px; margin-bottom: 20px;">
            <button id="btn-find-today" class="btn btn-green" style="flex:2;">ğŸ“… AVAA TÃ„MÃ„ PÃ„IVÃ„</button>
            <button id="btn-show-stats" class="btn btn-blue" style="flex:1;">ğŸ“Š TILASTOT</button>
        </div>
        
        <div class="card-form">
            <h3 id="new-event-toggle" style="margin-top:0; color:#B22222; text-align:center;">â• LisÃ¤Ã¤ uusi (Klikkaa tÃ¤stÃ¤)</h3>
            <div id="new-event-form" style="display: none;">
                <input type="file" id="import-gpx-new" accept=".gpx">
                <textarea id="import-text" rows="3" placeholder="Tai liitÃ¤ teksti tÃ¤hÃ¤n..."></textarea>
                <button id="btn-process-import" class="btn btn-gray btn-small">ğŸª„ TÃ¤ytÃ¤ tekstistÃ¤</button>
                <select id="new-type">
                    <option value="miitti">â˜• Miitti</option>
                    <option value="cito">ğŸ—‘ï¸ CITO</option>
                    <option value="cce">ğŸ‰ YhteisÃ¶juhla</option>
                </select>
                <input type="text" id="new-gc" placeholder="GC-koodi">
                <input type="text" id="new-name" placeholder="Nimi">
                <input type="date" id="new-date">
                <input type="text" id="new-time" placeholder="Klo (esim. 18:00-19:00)">
                <input type="text" id="new-coords" placeholder="Koordinaatit">
                <input type="text" id="new-loc" placeholder="Paikka">
                <textarea id="new-desc" rows="4" placeholder="HTML kuvaus..."></textarea>
                <button id="btn-add-event" class="btn btn-blue">Tallenna Tapahtuma</button>
            </div>
        </div>

        <div id="admin-lists-container">
            <details class="list-section" open>
                <summary class="list-summary">â˜• Miitit</summary>
                <details class="list-subsection" open>
                    <summary class="list-subsummary">Tulevat</summary>
                    <div id="list-miitti-future"></div>
                </details>
                <details class="list-subsection">
                    <summary class="list-subsummary">Menneet</summary>
                    <div id="list-miitti-past"></div>
                </details>
            </details>

            <details class="list-section">
                <summary class="list-summary">ğŸ‰ YhteisÃ¶juhlat</summary>
                <details class="list-subsection" open>
                    <summary class="list-subsummary">Tulevat</summary>
                    <div id="list-cce-future"></div>
                </details>
                <details class="list-subsection">
                    <summary class="list-subsummary">Menneet</summary>
                    <div id="list-cce-past"></div>
                </details>
            </details>

            <details class="list-section">
                <summary class="list-summary">ğŸ—‘ï¸ CITO Tapahtumat</summary>
                <details class="list-subsection" open>
                    <summary class="list-subsummary">Tulevat</summary>
                    <div id="list-cito-future"></div>
                </details>
                <details class="list-subsection">
                    <summary class="list-subsummary">Menneet</summary>
                    <div id="list-cito-past"></div>
                </details>
            </details>
        </div>
    </div>

    <div id="user-view" class="view-section">
        <div id="today-notice-user"></div>
        <h2>ğŸ“– Miittikirjat</h2>
        <button id="btn-show-stats-user" class="btn btn-blue">ğŸ“Š KATSO TILASTOT</button>
        <div id="user-lists-container">
            <details class="list-section" open>
                <summary class="list-summary">â˜• Miitit</summary>
                <details class="list-subsection" open>
                    <summary class="list-subsummary">Tulevat</summary>
                    <div id="user-list-miitti-future"></div>
                </details>
                <details class="list-subsection">
                    <summary class="list-subsummary">Menneet</summary>
                    <div id="user-list-miitti-past"></div>
                </details>
            </details>
            <details class="list-section">
                <summary class="list-summary">ğŸ‰ YhteisÃ¶juhlat</summary>
                <details class="list-subsection" open>
                    <summary class="list-subsummary">Tulevat</summary>
                    <div id="user-list-cce-future"></div>
                </details>
                <details class="list-subsection">
                    <summary class="list-subsummary">Menneet</summary>
                    <div id="user-list-cce-past"></div>
                </details>
            </details>
            <details class="list-section">
                <summary class="list-summary">ğŸ—‘ï¸ CITO Tapahtumat</summary>
                <details class="list-subsection" open>
                    <summary class="list-subsummary">Tulevat</summary>
                    <div id="user-list-cito-future"></div>
                </details>
                <details class="list-subsection">
                    <summary class="list-subsummary">Menneet</summary>
                    <div id="user-list-cito-past"></div>
                </details>
            </details>
        </div>
    </div>

    <div id="stats-view" class="view-section">
        <button onclick="showMainView()" class="back-btn">< Takaisin</button>
        <div style="clear:both;"></div>
        <h2>ğŸ“Š Tilastot & Graafit</h2>

        <div class="card-form">
            <input type="text" id="search-miitti-name" placeholder="Hae miittiÃ¤...">
            <div style="position:relative;">
                <input type="text" id="search-user-name" placeholder="Etsi kÃ¤tkÃ¶ilijÃ¤Ã¤...">
                <div id="user-autocomplete" class="autocomplete-list" style="display:none;"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <select id="filter-year"><option value="">Kaikki vuodet</option></select>
                <select id="filter-month">
                    <option value="">Kaikki kuukaudet</option>
                    <option value="01">Tam</option><option value="02">Hel</option><option value="03">Maa</option>
                    <option value="04">Huh</option><option value="05">Tou</option><option value="06">Kes</option>
                    <option value="07">Hei</option><option value="08">Elo</option><option value="09">Syy</option>
                    <option value="10">Lok</option><option value="11">Mar</option><option value="12">Jou</option>
                </select>
            </div>
            <button id="btn-apply-filters" class="btn btn-green btn-small">PÃ¤ivitÃ¤</button>
        </div>

        <div class="tab-container">
            <button class="tab-btn active" onclick="switchStatsTab('tab-lists', this)">ğŸ“ Listat</button>
            <button class="tab-btn" onclick="switchStatsTab('tab-graphs', this)">ğŸ“Š Graafit</button>
            <button class="tab-btn" onclick="switchStatsTab('tab-map', this)">ğŸ—ºï¸ Kartta</button>
        </div>

        <div id="tab-lists" class="tab-content active">
            <div class="card">
                <h3>ğŸ‘¥ KÃ¤vijÃ¤luettelo</h3>
                <div id="stats-user-registry" class="scroll-box" style="max-height: 400px;"></div>
                <small style="color:#888;">* NÃ¤ytetÃ¤Ã¤n max 50 aktiivisinta haun perusteella</small>
            </div>

            <div class="card"><h3>ğŸ“ˆ Yhteenveto</h3><div id="stats-summary-text"></div></div>
            
            <div class="card"><h3>ğŸ—“ï¸ Aktiivisuuskalenteri</h3><div id="stats-year-heatmap" class="scroll-box"></div></div>

            <div class="card"><h3>ğŸ” Haun tulokset (Miitit)</h3><div id="stats-results-list" class="scroll-box"></div></div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="card"><h3>ğŸ† TOP 10 Miitit</h3><div id="stats-top-10" style="font-size:0.8em;"></div></div>
                <div class="card"><h3>ğŸ§Š BOTTOM 10 Miitit</h3><div id="stats-bottom-10" style="font-size:0.8em;"></div></div>
            </div>
            
            <div class="card"><h3>ğŸ‘¥ TOP 10 KÃ¤vijÃ¤t</h3><div id="stats-top-users"></div></div>
            
            <div class="card"><h3>ğŸ”º YhteisÃ¶uskollisuus</h3><div id="stats-loyalty"></div></div>

            <div class="card">
                <h3>â° Aloitusajat (15 min)</h3>
                <div id="stats-time-slots" class="stats-grid"></div>
            </div>

            <div class="card">
                <h3>ğŸ”¤ Alkukirjaimet</h3>
                <div id="stats-alphabet" class="stats-grid"></div>
                <div id="stats-special-chars" style="margin-top:10px; font-size:0.8em; text-align:left; border-top:1px solid #eee; padding-top:10px;"></div>
            </div>
            <div class="card"><h3>ğŸ˜ï¸ Paikkakunnat</h3><div id="stats-locations" style="max-height: 200px; overflow-y: auto;"></div></div>
            
            <div class="card"><h3>â­ Attribuutit</h3><div id="stats-attributes" class="scroll-box"></div></div>

            <div class="card"><h3>â˜ï¸ Sanalouhos (Viestit)</h3><div id="stats-wordcloud"></div></div>
        </div>

        <div id="tab-graphs" class="tab-content">
            <div class="card"><h3>ğŸ“Š ViikonpÃ¤ivien suosio</h3><canvas id="chart-weekdays-canvas"></canvas></div>
            <div class="card"><h3>ğŸ© Miittityypit</h3><canvas id="chart-types-canvas"></canvas></div>
            <div class="card"><h3>ğŸ“ˆ KÃ¤vijÃ¤mÃ¤Ã¤rÃ¤n kehitys</h3><canvas id="chart-timeline-canvas"></canvas></div>
            <div class="card"><h3>ğŸš€ YhteisÃ¶n kumulatiivinen kasvu</h3><canvas id="chart-cumulative-canvas"></canvas></div>
            
            <div class="card"><h3>ğŸ•’ Suosituimmat kellonajat (Tunnit)</h3><canvas id="chart-hours-canvas"></canvas></div>
            <div class="card"><h3>ğŸ“… KÃ¤vijÃ¤t kuukausittain</h3><canvas id="chart-months-canvas"></canvas></div>
            <div class="card"><h3>ğŸ˜ï¸ Suosituimmat paikkakunnat</h3><canvas id="chart-locations-canvas"></canvas></div>
            <div class="card"><h3>ğŸ‘¥ TOP 10 KÃ¤vijÃ¤t</h3><canvas id="chart-top-attendees-canvas"></canvas></div>
            <div class="card"><h3>ğŸ† TOP 10 Miitit</h3><canvas id="chart-top-events-canvas"></canvas></div>
            <div class="card"><h3>â­ Suosituimmat attribuutit</h3><canvas id="chart-attributes-canvas"></canvas></div>
        </div>

        <div id="tab-map" class="tab-content">
            <div class="card" style="padding:5px;">
                <div id="stats-map" style="width:100%; border-radius:4px;"></div>
                <div style="text-align:center; padding:10px; color:#888;">NÃ¤ytetÃ¤Ã¤n miitit, joilla on koordinaatit.</div>
            </div>
        </div>
    </div>

    <div id="guestbook-view" class="view-section">
        <button onclick="showMainView()" class="back-btn">< Takaisin listaan</button>
        <div style="clear:both;"></div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <button onclick="navigateEvent(1)" class="nav-arrow">â®</button>
            <h2 id="gb-event-name" style="flex:1;"></h2>
            <button onclick="navigateEvent(-1)" class="nav-arrow">â¯</button>
        </div>
        <div id="archived-notice" style="display:none; background:#ccc; color:#333; padding:10px; border-radius:5px; margin-bottom:15px; font-weight:bold;">ğŸ”’ ARKISTOITU</div>
        
        <div class="event-meta">
            <span id="gb-time"></span><span id="gb-date"></span><span id="gb-loc"></span><span id="gb-gc"></span><span id="gb-coords"></span>
        </div>

        <div id="qr-section" style="margin-bottom:10px; display:none;">
            <button id="btn-toggle-qr" class="btn btn-small btn-blue" style="width:100%;">ğŸ“± NÃ„YTÃ„ QR-KOODI VIERAILLE</button>
            <div id="qr-display-area">
                <div id="qr-lang-toggle" class="qr-lang-toggle">
                    <button class="btn btn-small btn-gray" onclick="setQrLanguage('fi')">ğŸ‡«ğŸ‡®</button>
                    <button class="btn btn-small btn-gray" onclick="setQrLanguage('en')">ğŸ‡¬ğŸ‡§</button>
                    <button class="btn btn-small btn-gray" onclick="setQrLanguage('sv')">ğŸ‡¸ğŸ‡ª</button>
                    <button class="btn btn-small btn-gray" onclick="setQrLanguage('et')">ğŸ‡ªğŸ‡ª</button>
                </div>
                <div id="qr-instructions" class="qr-instructions"></div>
                <div id="qrcode-container"></div>
                <p id="qr-link-text" style="font-size:0.6em; color:#888; margin-top:5px;"></p>
            </div>
        </div>

        <div id="gb-admin-tools" style="display:none;">
            <button onclick="checkNetLog()" class="btn btn-small btn-blue" style="margin-bottom:5px;">ğŸŒ Tarkista nettilogi</button>
            
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button id="btn-sync-gpx-trigger" class="btn btn-small btn-green" style="flex:1;">ğŸ”„ GPX Sync</button>
                <button onclick="openMassImport()" class="btn btn-small btn-gray" style="flex:1;">ğŸ“¥ Massa</button>
            </div>
            <input type="file" id="import-gpx-sync" accept=".gpx" style="display:none;">
        </div>

        <div id="box-attrs" class="details-box" style="display:none;">
            <div class="details-header" onclick="toggleDetails('gb-attrs')"><span>â­ Attribuutit</span><span>â–¼</span></div>
            <div id="gb-attrs" class="details-content"></div>
        </div>
        <div id="box-desc" class="details-box" style="display:none;">
            <div class="details-header" onclick="toggleDetails('gb-description')"><span>ğŸ“– Kuvaus</span><span>â–¼</span></div>
            <div id="gb-description" class="details-content description-container"></div>
        </div>
        
        <div id="gb-actions-area">
            <div class="details-box" style="margin-bottom:15px;">
                <div class="details-header" onclick="toggleDetails('manual-log-wrapper')" style="background:#FFF8DC; border:1px solid #D2691E;">
                    <span style="font-weight:bold; color:#B22222;">âœï¸ LisÃ¤Ã¤ kÃ¤vijÃ¤ manuaalisesti</span>
                    <span>â–¼</span>
                </div>
                
                <div id="manual-log-wrapper" class="details-content" style="display:none; padding:10px;">
                    <div class="card-form" style="margin:0; box-shadow:none; border:none; padding:0;">
                        <div style="position:relative;">
                            <input type="text" id="log-nickname" placeholder="Nimimerkki" style="font-size:1.2em; border:2px solid #8B4513;">
                            <div id="log-autocomplete" class="autocomplete-list" style="display:none;"></div>
                        </div>
                        
                        <small style="display:block; color:#666; margin-top:2px; margin-bottom:10px; font-style:italic;">(Kirjoita kuten Geocaching.comissa)</small>

                        <input type="text" id="log-from" placeholder="MistÃ¤ tulet?">
                        <input type="text" id="log-message" placeholder="Terveiset">
                        <button id="btn-sign-log" class="btn btn-green" style="font-size:1.2em; box-shadow:4px 4px 0px #2e7d32; width:100%;">KIRJAA âœ…</button>
                    </div>
                </div>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Osallistujat</h3>
            <span id="attendee-count" style="background:#8B4513; color:#fff; padding:2px 10px; border-radius:15px;">0</span>
        </div>
        <div id="attendee-list" class="log-list"></div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="modal-content confirm-modal-content">
            <h3 id="confirm-title"></h3><p id="confirm-message"></p>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button id="btn-confirm-yes" class="btn btn-green">KyllÃ¤</button>
                <button id="btn-confirm-no" class="btn btn-red">Ei</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h3>âœï¸ Muokkaa</h3>
            <input type="hidden" id="edit-key">
            <label>Nimi</label><input type="text" id="edit-name">
            <label>Tyyppi</label><select id="edit-type"><option value="miitti">Miitti</option><option value="cito">CITO</option><option value="cce">YhteisÃ¶juhla</option></select>
            <label>GC</label><input type="text" id="edit-gc">
            <label>Pvm</label><input type="date" id="edit-date">
            <label>Aika</label><input type="text" id="edit-time">
            <label>Koordinaatit</label><input type="text" id="edit-coords">
            <label>Paikka</label><input type="text" id="edit-loc">
            <label>HTML Kuvaus</label><textarea id="edit-desc" rows="5"></textarea>
            <div style="display:flex; gap:10px;"><button id="btn-save-edit" class="btn btn-green">Tallenna</button><button onclick="closeModal()" class="btn btn-red">Peruuta</button></div>
        </div>
    </div>

    <div id="mass-modal" class="modal">
        <div class="modal-content">
            <h3>ğŸ“¥ Massa-tuonti</h3>
            <div id="mass-step-1"><textarea id="mass-input" rows="8" placeholder="LiitÃ¤ teksti..."></textarea><button id="btn-parse-mass" class="btn btn-blue">Etsi nimet</button></div>
            <div id="mass-step-2" style="display:none;"><textarea id="mass-output" rows="10"></textarea><div style="display:flex; gap:10px;"><button id="btn-save-mass" class="btn btn-green">Tallenna</button><button onclick="resetMassModal()" class="btn btn-gray">Takaisin</button></div></div>
            <button onclick="closeModal()" class="btn btn-red" style="margin-top:20px; width:100%;">Sulje</button>
        </div>
    </div>

    <div id="log-edit-modal" class="modal">
        <div class="modal-content">
            <h3>âœï¸ Muokkaa kÃ¤vijÃ¤Ã¤</h3>
            <input type="hidden" id="log-edit-key">
            <label>Nimimerkki</label><input type="text" id="log-edit-nick">
            <label>Kotoisin</label><input type="text" id="log-edit-from">
            <label>Viesti</label><textarea id="log-edit-msg" rows="3"></textarea>
            <div style="display:flex; gap:10px; margin-top:20px;"><button id="btn-save-log-edit" class="btn btn-green">Tallenna</button><button onclick="closeModal()" class="btn btn-red">Peruuta</button></div>
        </div>
    </div>

    <div id="user-profile-modal" class="modal">
        <div class="modal-content">
            <h3 id="up-nickname" style="border-bottom:2px solid var(--primary-color); padding-bottom:10px; margin-bottom:15px;"></h3>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:15px; text-align:center;">
                <div style="background:var(--highlight-bg); padding:10px; border-radius:8px; border:1px solid var(--border-color);">
                    <div style="font-size:0.8em; opacity:0.8;">MiittejÃ¤</div>
                    <div id="up-total" style="font-size:1.4em; font-weight:bold; color:var(--secondary-color);">0</div>
                </div>
                <div style="background:var(--highlight-bg); padding:10px; border-radius:8px; border:1px solid var(--border-color);">
                    <div style="font-size:0.8em; opacity:0.8;">EnsimmÃ¤inen</div>
                    <div id="up-first" style="font-size:0.9em; font-weight:bold;">-</div>
                </div>
                <div style="background:var(--highlight-bg); padding:10px; border-radius:8px; border:1px solid var(--border-color);">
                    <div style="font-size:0.8em; opacity:0.8;">Viimeisin</div>
                    <div id="up-last" style="font-size:0.9em; font-weight:bold;">-</div>
                </div>
            </div>

            <h4>Historia</h4>
            <div id="up-history-list" class="scroll-box" style="max-height: 250px;"></div>
            
            <div id="visitor-action-buttons">
                <button onclick="document.getElementById('user-profile-modal').style.display='none'" class="btn btn-red" style="margin-top:15px;">Sulje</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <script src="messages.js"></script>
    <script src="visitor.js"></script>
    
    <script src="app.js"></script>
    <script src="stats.js"></script>
    
    <script>
        function switchStatsTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
            
            if(tabId === 'tab-graphs' && typeof renderCharts === 'function') {
                setTimeout(() => { renderCharts(window.currentFilteredData); }, 100);
            }
            if(tabId === 'tab-map' && typeof renderMap === 'function') {
                setTimeout(() => { renderMap(window.currentFilteredData); }, 100);
            }
        }

        // --- TEEMAHALLINTA ---
        const themes = [
            { class: '', icon: 'ğŸŒ™', name: 'YÃ¶' },       
            { class: 'theme-light', icon: 'â˜€ï¸', name: 'PÃ¤ivÃ¤' },
            { class: 'theme-green', icon: 'ğŸŒ²', name: 'MetsÃ¤' },
            { class: 'theme-blue', icon: 'ğŸŒŠ', name: 'Meri' }
        ];

        let currentThemeIndex = 0;

        function initTheme() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('event')) {
                currentThemeIndex = 1;
                applyTheme();
                return;
            }
            const saved = localStorage.getItem('mk-theme-idx');
            if (saved !== null) {
                currentThemeIndex = parseInt(saved);
            }
            applyTheme();
        }

        function toggleTheme() {
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            localStorage.setItem('mk-theme-idx', currentThemeIndex);
            applyTheme();
        }

        function applyTheme() {
            document.body.classList.remove('theme-light', 'theme-green', 'theme-blue');
            const theme = themes[currentThemeIndex];
            if (theme.class) {
                document.body.classList.add(theme.class);
            }
            const btn = document.getElementById('btn-theme-toggle');
            if(btn) btn.innerText = theme.icon;
        }

        initTheme();
    </script>
</body>
</html>
